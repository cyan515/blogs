## ドメイン駆動設計とは

### ドメインモデルとは何か

ペンを考えたとき、小説家にとっては商売道具であり、文字が書けること、長く使えること、書きやすいこと、などが関心事として挙げられる。

一方、文房具店にとっては、売価や原価などが関心事として重要になる。

一見して対象が同じものであっても、見るべきアスペクトが異なるという場合が非常に多く存在する。

例えば物流システムにおいては、トラックは荷運びをするものとして表現されるのであって、エンジンキーを回すとエンジンがかかる、といったことまで表現する必要はない。

### パターン

- 知識を表現するパターン
    - 値オブジェクト
    - エンティティ
    - ドメインサービス
- アプリケーションを実現するためのパターン
    - リポジトリ
    - アプリケーションサービス
    - ファクトリ
- 知識を表現する、より発展的なパターン
    - 集約
    - 仕様

## システム固有の値を表現する「値オブジェクト」

金銭、製造番号、氏名、などといった値を表現するオブジェクト。特徴として

- 不変である
- 交換可能である
- 等価性によって比較できる

といったものが挙げられる。不変はそのままの意味。

交換可能である、とは、例えばある人物エンティティの登録名の名字だけ変えたくなったとき、値オブジェクトは不変であるから、氏名オブジェクトの名字だけ変えるとかはできない。
その代わり、「氏名オブジェクトごと」取り換える、というような操作をすることになる。要するに、上書きの最小単位と言ってもいいかもしれない。

等価性に関しては言語にもよるが、例えば Java なら `Object#equals` をちゃんと override しようね、という話。

### 何を値オブジェクトとして定義するか？

例えば先の氏名の例では、

- `FullName` という型のみ作成し、内部的には `string` で持つ。
- `FullName` という型に加え、`FirstName` `LastName` という型も作成し、これらを `FullName` の field に持つ。

といった実装が考えられる。どちらがいいかは context による。

……とは言っても、判断基準がないと困る。

- そこにルールが存在しているか？
- それ単体で取り扱いたいか？

を考えるとよい。

### 定義されないからこそわかること

例えば、金銭オブジェクト `Money` を考えてみる。金額同士を足し引きすることは極めて自然でシステム上でももちろん行われ得ることだが、一方で金銭同士の乗算が意味を持つ場面はそうない。

つまり、100 円 + 100 円 = 200 円 という演算には意味があるが、100 円 * 100 円 = 10000 円<sup>2</sup> という演算には意味がない（円<sup>2</sup> って何よ？って話）。

したがって、`Money` オブジェクトには `Add` が method として生えるとしても、`Multiply` のような method を生やす必要はないし、生やしてはいけない。

このように、`Multiply` を定義しないことによって、この型の使用者（つまり、他の開発者）にとって、「そういう操作はこのシステム上で行われえない操作なのだ」ということがすぐわかるようになる。
（逆に、これを primitive な整数型とかで持っちゃうと、かけ算できちゃうからそういう操作をやっちゃう開発者が出てくる可能性を否定できない）

### 値オブジェクトを採用するモチベーション

- 表現力を増す
    - 前述の `Money` オブジェクトみたいな話。何ができるか、何はできないのか、が表現できるようになる。
- 不正な値を存在させない
    - オブジェクトに対して不正な操作が行われたら例外を投げることができる。
- 誤った代入を防ぐ
    - 静的型付けにおいて、例えば金額と製造シリアル番号、両者を別の型として定義しておけば、これらを取り違えて代入しちゃった、なんてことがなくなる。
- ロジックの散財を防ぐ
    - 前述の `FullName` の等価性判定の話。等価性判定のロジックが色々なところに書かれてたら嫌なので。

## ライフサイクルのあるオブジェクト「エンティティ」
## 不自然さを解決する「ドメインサービス」
## データにまつわる処理を分離する「リポジトリ」
## ユースケースを実現する「アプリケーションサービス」
## 柔軟性をもたらす依存関係のコントロール
## ソフトウェアシステムを組み立てる
## 複雑な生成処理を行う「ファクトリ」
## データの整合性を保つ
## アプリケーションを 1 から組み立てる
## ドメインのルールを守る「集約」
## 複雑な条件を表現する「仕様」
## アーキテクチャ
## ドメイン駆動設計のとびらを開こう
## ソリューション構成
